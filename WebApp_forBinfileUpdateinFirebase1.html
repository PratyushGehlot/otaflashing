<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

<!-- including Firebase -->
<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.2.1/firebase.js"></script>

<!-- Firebase -->
<script>
  // Initialize Firebase
  var config = {
    apiKey: "mZySauKG58fA1gGCh6guF13at2KRpEjlSMvs8Znl",
    authDomain: "espotaupdate.firebaseapp.com",
    databaseURL: "https://espotaupdate.firebaseio.com",
    projectId: "espotaupdate",
    storageBucket: "espotaupdate.appspot.com",
    messagingSenderId: "251170758790"
  };
  firebase.initializeApp(config);
</script>
<!--

<form method="post" enctype="multipart/form-data">
    <input type="file" name="uploadFirmwareFile">
    <input class="button" type="submit" value="uploadFirmwareFile">
</form>
-->

<script>
var storageRef = null;
//----------------------------------------------------
// Assuming you use jQuery:
/*$('#uploadFirmwareFile').change(function() 
{
  console.log("read file1");
  var file = $('#uploadFirmwareFile')[0].files[0];    
  readFile(file);
  console.log("read file2");
});*/
//----------------------------------------------------
// Read the file chosen by the user.
function readFile(file) 
{
  // Open the file and start reading it.
  var reader = new FileReader();
  
  reader.readAsArrayBuffer(file);
  //reader.readAsText(file);
  
  reader.onload = function() {
    console.log(reader.result);
  };
  
  reader.onloadend = function(event) {   
    console.log("File contents: " + event.target.result);  
	console.log("reader.result: " + reader.result); 
    readMetadata(file, reader.result);
  };
  
  reader.onerror = function(event) {
    console.error("File could not be read! Code " + event.target.error.code);
  };
    var storage = firebase.storage();
    storageRef = storage.ref();
}
//----------------------------------------------------
// Extract the version string from the given file data.
function getFirmwareVersion(data) 
{
  var enc = new TextDecoder("utf-8");
  var s = enc.decode(data);
  
  //var re = new RegExp("__MaGiC__ Aug 24 2019 07:40:57__");
  //var re = new RegExp("__MaGiC__ [^_]+__");
  var re = new RegExp("__FlowMeter__ [^_]+__");
  //var re = new RegExp("__MaGiC__ [^_]+ ___");
  
  var result = re.exec(s);
  if (result == null) 
  {
    return null;
  }
  console.log("version --:");
  console.log(result[0]);
  return result[0];
}
//----------------------------------------------------
// Called when we're done reading the file data.
function readMetadata(file, data) 
{
  version = getFirmwareVersion(data);
  if (version == null) 
  {
    console.log("Could not extract magic string from binary.");
    return;
  }  
  // Upload firmware binary to Firebase Cloud Storage.
  // We use the version string as the filename, since
  // it's assumed to be unique. 
  console.log('Got firmware version' + version);
  
  // Start the upload.
  $('#uploadFirmwareSpinner').show();
  
  var uploadRef = storageRef.child(version); 
  uploadRef.put(file).then(function(snapshot) {
		$('#uploadFirmwareSpinner').hide();
		console.log('Upload complete');
		// Upload completed. Get the URL. 
		uploadRef.getDownloadURL().then(function(url) {
		saveMetadata(file.name, version, url);
    });
  });
}
//----------------------------------------------------
// Save the metadata to Realtime Database.
function saveMetadata(filename, version, url) 
{
  var dbRef = firebase.database().ref('firmware/' + version);
  var metadata = {
    // This bit of magic causes Firebase to write the
    // server timestamp when the data is written to the
    // database record.
    dateUploaded: firebase.database.ServerValue.TIMESTAMP,
    filename: filename,
    url: url,
  };
  
  // push this temporary object into firebase for storage
  //database.ref().push(metadata);
  
 
  dbRef.set(metadata).then(function() {
    console.log("Success!");
  })
  .catch(function(error) {
    console.log("Error: " + error.message);
  });
}
//----------------------------------------------------
var mac = '3C:71:BF:3A:0F:97';
var dbRef = firebase.database().ref('config/' + mac);
dbRef.set({
  version: '__MaGiC__ Aug 24 2019 09:14:50__'
}).then(function() {
  console.log('Success!'); 
})
.catch(function(error) {
  console.log('Error: ' + error.message);
});
//----------------------------------------------------
</script>


<!-- Upload firmware dialog modal -->
<form id = "uploadForm" name = "uploadForm" enctype="multipart/form-data">
    <label for="uploadFile">Upload Your File</label>
     <input type="file" name="uploadFile" id="uploadFirmwareFile">                  
</form>
<script>
    $('#uploadFirmwareFile').change(function(){
        var fileName = this.files[0].name;
        var fileSize = this.files[0].size;
        var fileType = this.files[0].type;
        alert('FileName : ' + fileName + '\nFileSize : ' + fileSize + ' bytes');
		
		var file = $('#uploadFirmwareFile')[0].files[0];    
		readFile(file);
		
		var fileName = $('#uploadFirmwareFile').val();
		console.log("reading :" + fileName);
    });
</script>
</head>
</body>
</html>